# 一：持久化
## 1、rdb持久化
### 触发rbd持久化的方式
* 手动执行`save`和`bgsave`命令
  * save命令由服务器进程执行保存工作，会阻塞服务器
  * bgsave命令由子进程执行保存工作，不会阻塞服务器
* 配置服务器定期执行
  * 服务器配置save，用于设置保存条件
  * 默认配置：
    * save 900  1  服务器在900秒内，对数据库进行了至少1次修改
    * save 300 10
    * save 60 10000
    * 只要满足以上的任意条件，bgsave命令都会被执行
### 载入rbd文件的条件
* 启动服务器
* 未开启aof持久化功能
### 与rbd持久化有关的数据库属性
* `dirty`：是一个计数器，记录距离上一次成功执行save命令或者bgsave命令之后，服务区对数据库状态修改的次数。
* `lastsvae`：是一个Unix时间戳，记录了服务器上一次成功执行save命令或者bgsave命令的时间
* 注意：redis服务器中有一个周期性执行的`serverCron函数`，默认每`100毫秒`执行一次，用于检查save选项所设置的保存条件是否已经满足，如果满足就执行bgsave命令
### rbd文件的结构
#### 总体结构
|`REDIS`|`db_version`|`database`|`EOF`|`check_sum`|
|--------|--------|--------|--------|--------|
* REDIS常量：5个字节，保存"redis"
* db_version：4个字节，rdb文件版本号
* database: 0 - N， 0到多个数据库
* EOF常量：1个字节，RDB正文结束标志位
* check_sum：8个字节，校验和
#### database结构
|`SELECTDB`|`db_number`|`key_value_pairs`|
|--------|--------|--------|
* SELECTDB常量：1字节，标志rdb下一部分内容是数据库号码 
* db_number：1，2，5字节，数据库号码
* key_value_pairs：数据库中所有键值对数据
#### key_value_pairs结构
|`TYPE`|`key`|`value`|
|--------|--------|--------|

|`EXPIRETIME_MS`|`ms`|`TYPE`|`key`|`value`|
|--------|--------|--------|--------|--------|
* EXPIRETIME_MS常量：1字节，标志下一部分内容是key的过期时间 
* ms：8字节，key的过期时间，Unix时间戳
* TYPE：1字节，value的类型
* key：字符串对象
* value：任意一种对象
#### 分析rdb文件
* flushall：清空数据库
* save：以阻塞的方式生成rdb文件
* od -c dump.rdb：以ascii编码的方式输出文件
* od -x dump.rdb：以16进制的方式输出文件
* redis-check-dump工具
---
## 2、aof持久化



---

# 二：持久化和复制功能对过期键的处理
## 1、`rbd`对过期键的处理
* 生成rdb文件：执行`save`命令和`bgsave`命令创建一个新rbd文件时，已过期的键不会被保存到新创建的rdb文件中
* 载入rdb文件：启动redis时，服务器开启了rdb功能，服务器将载入rdb文件
    * 服务器以`主服务器模式`运行，载入rdb文件时，程序只会保留未过期的键
    * 服务器以`从服务器模式`运行，载入rdb文件时，程序会保留所有键。主从服务器在进行数据同步的时候，从服务器的数据库会被清空。
---
## 2、`aof`对过期键的处理
* aof文件写入：当过期键被删除时，程序回向aof文件追加一条`del命令`，显示记录该键被删除
* aof重写：在执行aof重写时，已过期的键不会被保存到重写后的aof文件中
---
## 3、`复制`对过期键的处理：
* 当服务器运行在`复制模式`下时，从服务器的过期键删除动作由`主服务器`控制
* 主服务器在删除一个过期键之后，会显式地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键；
* 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键；
* 从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键。
* 目的：主服务器控制从服务器统一删除过期键，保证主从服务器数据一致性。
## 4、总结
* 执行`save`命令或者`bgsave`命令，新生成的`rdb`文件不会包含已过期的键
* 执行`bgrewrite`命令，生成的重写`aof`文件不会保留已过期的键
* 当一个过期键被删除后，服务器会在aof文件的末尾追加一条del命令，显示删除过期键
* 主服务器控制从服务器统一删除过期键，这种统一、中心化的过期删除策略可以保证主从
