# Redis事务
* 事务提供了一种将多个命令打包，然后一次性、按顺序地执行机制
* 事务在执行过程中不会被中断，当事务队列中的所有命令都执行完毕之后，事务才会结束。
## 1、与事务有关的命令
* `multi`：开始事务
* `exec`：执行事务
* `discard`：取消事务，放弃执行事务块内的所有命令。 
* `watch`：监视一个或多个数据库键，
* `unwatch`: 取消监控数据库键
---
### 2、事务的应用场景
* 的
---
### 3、事务的实现
* 开始事务
  * `multi命令`的执行标志着事务的开始。
  * 客户端处于事务状态。
* 命令入队
  * 客户端处于`非事务状态`时，客户端发送的命令会被服务器立刻执行
  * 客户端处于`事务状态`时，分以下两种情况
    * 客户端发送的命令是`multi`、`exec`、`discard`、`watch`,服务器会立刻执行
    * 客户端发送的命令不是以上命令，服务器会将命令放入`事务队列`里面，并给客户端返回一个queued回复
    * 事务队列是一个数组。
* 执行事务
  * 服务器会遍历客户端的事务队列，执行队列中保存的所有命令，最后将执行命令所得的结果全部返回给客户端
* 核心思想：使用一个FIFO队列存储事务中需要执行的命令，实现命令打包、顺序，一次性执行
---
### 4、watch命令
* 可以使用watch命令实现`乐观锁`
* watch命令可在exec命令前执行，用于监控一个或多个数据库键
* 在执行exec命令前，如果被监视的键被修改，服务器拒绝执行事务，并给客户端返回nil
* watch命令的原理
  * `watched_keys字典`
    * 每个数据库都有一个`watched_keys字典`
    * `KEY`是被watch命令监视的数据库键
    * `VALUE是`一个链表，每个节点记录的是监控KEY的客户端
* 事务安全性
  * 每当执行了修改数据库状态的命令之后，都会根据命令中的key查找对应的客户端
  * 并将客户端的`REDIS_DIRTY_CAS标识`打开，标明该客户端的事务安全性已经被破坏
  * 当服务器exec命令时，会去检查客户端的REDIS_DIRTY_CAS标识，决定是否执行事务。
---
### 5、Redis事务的性质ACID
* 原子性：事务队列中的命令要么全部执行，要么一个也不执行
* 一致性：Redis事务可能出错的地方，以及对应的解决方案
  * 1、`入队错误`：在事务的`命令入队`过程中，出现了命令不存在、命令格式不正确等情况，Redis会决绝执行事务。
  * 2、`执行错误`：在执行事务队列中的命令时，出现了错误。但是出错的命令不会对数据库有任何修改
  * 3、`服务器停机`：无论Redis是否开启持久化功能，重启后都会恢复到上一个一致性状态。
* 隔离性：redis中的事务是以串行的方式运行，并且事务执行期间不会中断。
* 持久性：Redis事务的持久性是由持久化模式决定的。
  * 未开启持久化功能：此时Redis事务不具备持久化功能
  * rdb持久化功能：此时Redis不具备持久化功能
  * aof持久化功能：Redis事务的持久性视aof同步策略而定
    * always：具备
    * everysec: 不具备
    * no：不具备
* 注意：Redis不支持事务回滚。Redis的设计宗旨是简单、高效
